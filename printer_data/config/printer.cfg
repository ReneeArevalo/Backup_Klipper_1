# This file contains common pin mappings for RAMPS (v1.3 and later)
# boards. RAMPS boards typically use a firmware compiled for the AVR
# atmega2560 (though the atmega1280 is also possible).

# See docs/Config_Reference.md for a description of parameters.

######################################################################
# This file is an example config file for linear delta style printers.
# One may copy and edit this file to configure a new delta printer.
#
# DO NOT COPY THIS FILE WITHOUT CAREFULLY READING AND UPDATING IT
# FIRST. Incorrectly configured parameters may cause damage.
#
# See docs/Config_Reference.md for a description of parameters.
######################################################################

######################################################################
# ARCHIVOS INCLUIDOS Y OTROS
######################################################################

[include mainsail.cfg]
[include macros.cfg]
[include KAMP_Settings.cfg]
[exclude_object] # Obligatorio para que KAMP sepa dónde hay piezas
[gcode_arcs]     # Recomendado para movimientos fluidos
[display_status] # Para que los mensajes M117 funcionen bien

[mcu]
serial: /dev/serial/by-id/usb-Arduino__www.arduino.cc__0042_55838323935351F00171-if00
restart_method: arduino				    # mecanismo que el host usará para reiniciar el microcontrolador. // arduino // command // rpi_usb
baud: 115200

######################################################################
# CONFIGURACION DE LA IMPRESORA (SINEMATICA - DELTA)
######################################################################

[printer]
kinematics: delta						# Tipo/sinematica de impresora / cartesian
#delta_radius: 155       				# Radio (en mm) del círculo horizontal formado por las tres torres de los ejes lineales. // 151
print_radius: 105						# Radio imprimible de la cama sin generar coliciones con las torres
max_velocity: 200						# Velocidad máxima de seguridad
max_accel: 1200 						# Aceleración máxima de seguridad  // 5000 // 500
max_z_velocity: 5 						# Velocidad máxima del eje Z de seguridad // 5 // 4
max_z_accel: 100						# Aceleración máxima del eje Z de seguridad  // 100
minimum_z_position: -2		    		# La posición mínima en Z a la que el usuario puede ordenar al cabezal que se mueva. El valor predeterminado es 0. // -2
minimum_cruise_ratio: 0.5				# Esta opción reduce la velocidad máxima de estos movimientos para garantizar que siempre haya una distancia mínima recorrida a una velocidad de crucero.
square_corner_velocity: 5      			# Este valor configura el algoritmo interno de velocidad centrípeta en curvas; las curvas con ángulos mayores a 90 grados tendrán una mayor velocidad de giro, mientras que las curvas con ángulos menores a 90 grados tendrán una velocidad de giro menor...  // 4 // 5

######################################################################
# CONFIGURACION DE MOTORES PAP. (X=a, Y=b, Z=c, E=extruder)
######################################################################

[stepper_a]
step_pin: PF0							# Pin de paso/mm, número mágico
dir_pin: PF1							# Pin de dirección, para invertir giro se antepone o retira el signo "!".
enable_pin: !PD7						# Pin de habilitación. Se antepone o retira el signo "!".
microsteps: 16							# Micropasos del Driver 8,16,32... 
rotation_distance: 8.409				# (200 Pasos/mm. "Motor" * 16 Micropasos-A4988)/400 pasos/mm. "Marlin"=8  // Cuadro (8*((84.03+83.83+84.41)/3))/80 ==> 8.409
endstop_pin: ^!PE4						# Pin de final de carrera NO/NC. Se antepone o retira el signo "!" para invertir // !PE5
#position_endstop: 385                   # ALTURA MÁXIMA REAL (a,b,c)
homing_speed: 5
#angle: 210
#arm_length: 292		   		       	    # Longitud (en mm) de la varilla diagonal (Brazoz) que conecta esta torre con el cabezal de impresión (DELTA_DIAGONAL_ROD). NOTA: Por defecto el valor tambien lo toman (stepper_b y stepper_c).

[stepper_b]
step_pin: PF6
dir_pin: PF7
enable_pin: !PF2
microsteps: 16
rotation_distance: 8.284                # // Cuadro (8*((82.79+82.82.86)/3))/80 ==> 8.284
endstop_pin: ^!PJ0
#angle: 330

[stepper_c]
step_pin: PL3
dir_pin: PL1
enable_pin: !PK0
microsteps: 16
rotation_distance: 8
endstop_pin: ^!PD2
#angle: 90

[extruder]
step_pin: PA4							# Pin de paso/mm, número mágico
dir_pin: PA6							# Pin de dirección
enable_pin: !PA2						# Pin de habilitación. Se antepone o retira el signo "!".
microsteps: 16							# Micropasos del Driver 8,16,32... 
rotation_distance: 37.69910             # // 4.523 (200 Pasos/mm. "Motor" * 16 Micropasos-A4988)/95.14 pasos/mm. "Marlin"=33.63 // Aprox. 34
                                        # 33.63 - 53.98 mm.
                                        #   X   - 50 mm.
                                        # NO SIRVE LA REGLA DE TRES SIMPLE: X = 33.63 * 50 / 53.98) = 36.3069 ===> Aprox. 36.31 "No"
                                        # NOTA INVERTIR LA REGLA DE TRES SIMPLE: X = 33.63 * 50 / 53.98) = 31.144 ===> Aprox. 31.14
                                        # Otro método es medir el diametro del piñon y multiplicar por Pi "3.141592". Ej.: Diam. = 10mm.  ===> 10 x 3.141592 = 31.41592 => Aprox. 31.416 // 12 x 3.141592 = 37.69910 // 37.03936
nozzle_diameter: 0.600					# Diametro de boquilla // 0.400
filament_diameter: 1.750				# Diametro de filamento // 0.400
max_extrude_cross_section: 50           # Esta configuración previene cantidades excesivas de extrusión durante movimientos XY relativamente pequeños.
max_extrude_only_distance: 650          # Longitud máxima (en mm de filamento crudo) que puede tener un movimiento de retracción o solo extrusión. // 300
heater_pin: PB4							# Pin del calentador del extrusor
sensor_type: EPCOS 100K B57560G104F		# Tipo de termistor // 100k thermistor - best choice for EPCOS 100k (4.7k pullup)
sensor_pin: PK5							# Pin de termistor
control: pid							# Tipo de control // pid // watermark
pid_kp: 30.169
pid_ki: 1.780
pid_kd: 127.841
min_extrude_temp: 170					# Temperatura mínima a la que comenzará a mover el Extrusor
min_temp: -5							# Temperatura mínima del Hotend/Extrusor
max_temp: 250							# Temperatura máxima del Hotend/Extrusor
pressure_advance: 0.36                  # Para extrusores directos el factor es 0.005 y bowden "Delta" el factor es 0.020    // 0.32 // 0.36 
                                        # (inicio "0" + Medida buena prueba imp. 16 mm.) * Factor "Bouden" 0.020
                                        # // (0 + 14)mm. * 0.020 = 0.28 // (0 + 16)mm. * 0.020 = 0.32 // (0 + 18)mm. * 0.020 = 0.36 // (0 + 32)mm. * 0.020 = 0.64

#[extruder1]
#step_pin: PC1
#dir_pin: PC3
#enable_pin: !PC7
#heater_pin: PH6
#sensor_pin: PK7
#...

######################################################################
# CONFIGURACION DE LA CAMA
######################################################################

[heater_bed]
heater_pin: PH5							# Pin del calentador de la cama
sensor_type: EPCOS 100K B57560G104F		# Tipo de termistor // 100k thermistor - best choice for EPCOS 100k (4.7k pullup)
sensor_pin: PK6							# Pin de termistor
control: pid
pid_kp: 61.707
pid_ki: 0.855
pid_kd: 1113.041
min_temp: 0								# Temperatura mínima de la cama
max_temp: 100							# Temperatura máxima de la cama

######################################################################
# CONFIGURACION DE LA VENTILACION
######################################################################

[heater_fan Enfriador_Extrusor]
pin: PH6                                # // PH6, PC13, PC8, PD12
max_power: 1.0
shutdown_speed: 1.00                    # // 0.00
cycle_time: 0.010
hardware_pwm: False
kick_start_time: 0.500					# inicio después de xx segundos
off_below: 0.65                         # Debe coincidir con "heater_temp"
fan_speed: 0.90							# 1.0 significa el 100% de la velocidad máxima del ventilador  // 0.90 // 1.0
heater: extruder
heater_temp: 65						# Temperatura a la que deja de funcionar el ventilador.

######################################################################
# CONTROL DE TEMPERATURA
######################################################################

[verify_heater extruder]
max_error: 500
check_gain_time: 20
hysteresis: 20
heating_gain: 2

[verify_heater heater_bed]
max_error: 120
check_gain_time: 60
hysteresis: 5
heating_gain: 2

######################################################################
# CALIBRACION DELTA
######################################################################

[delta_calibrate]
radius: 95								# Radio (en mm) del área que se puede sondear. // 72
speed: 25								# Velocidad de calibración  // 50
horizontal_move_z: 15					# Altura (en mm) a la que se debe ordenar mover la cabeza justo antes de iniciar una operación de sondeo. El valor predeterminado es 5. // 10

[probe]
pin: ^PD3				            	# La sonda está conectada al pin 7, que es un pin estándar para sondas Z. // tambien probar con !PC7, !PE5, !PJ1, !PD3
                                        # ^ = pull-up interno
                                        # ! = lógica invertida (LM393 normalmente es activo LOW). Si tu sensor dispara al revés, quita !
x_offset: 0.0
y_offset: 0.0
#z_offset: -0.650						# Altura Z de la sonda (cuando se activa).  // 3
speed: 5   								# Velocidad de sondeo.
lift_speed: 5  				        	# Velocidad (en mm/s) del eje Z al levantar la sonda entre muestras. El valor predeterminado es usar el mismo valor que el parámetro 'velocidad'.
samples: 5          					# Número de veces que se medirá cada punto de nivelación. // 1
samples_result: average
sample_retract_dist: 5					# Distancia de retracción de la sonda Z entre muestras.  // 2
samples_tolerance: 0.022				# La distancia máxima en Z (en mm) que una muestra puede diferir de otras muestras. Si se excede esta tolerancia, se reporta un error o se reinicia el intento. El valor predeterminado es 0.100 mm. 
samples_tolerance_retries: 5			# El número de veces que se intentará de nuevo si se encuentra una muestra que exceda - samples_tolerance-. En un reintento, todas las muestras actuales se descartan y se reinicia el intento de sondeo. De lo contrario se reporta un error. El valor predeterminado es cero.
activate_gcode:
    G4 P150                             # Tiempo de estabilización del sensor
deactivate_gcode:
    G4 P100

########################################################################################
# AJUSTE DE TORNILLOS NIVELADORES (4 TORNILLOS M3*45MM.) PARA NIVELADO DE CAMA
########################################################################################

# USO: 1. Precalentamiento de Cama y Hotend "Operacionales de 1er capa". 
#      2. Hacer Home. 
#      3. Iniciar el la funcion "Screews Tilt Calculate".
#      4. Seguir los ajustes que se requieran "rojos" teniendo en cuenta como base el tornillo #1
#      5. Realizar hasta ajustar aproximadamente "El giro se da en minutos de acuerdo al resultado horario o antihorario"

[screws_tilt_adjust]
screw1: -70,-70				        	# Coordenada Tornillo #1 "Tornillo Frontal Izquierdo" // 58,70
screw1_name: Tornillo Delantero Izquierdo	       	# Tornillo Frontal Izquierdo #1, front left screw
screw2: 70,-70				        	# Coordenada Tornillo #2 "Tornillo Frontal Derecho" // 216,70
screw2_name: Tornillo Delantero Derecho	       	# Tornillo Frontal Derecho #2, front right screw
screw3: 70,70				        	# Coordenada Tornillo #3 "Tornillo Trasero Derecho" // 216,224
screw3_name: Tornillo Trasero Derecho	       	# Tornillo Trasero Derecho #3, rear right screw
screw4: -70,70				        	# Coordenada Tornillo #4 "Tornillo Trasero Izquierdo" // 58,224
screw4_name: Tornillo Trasero Izquierdo	       	# Tornillo Trasero Izquierdo #4, rear left screw
horizontal_move_z: 15				    # Altura de levantamiento de la boquilla para movimientos // 10
speed: 30 								# Velocidad de movimiento
screw_thread: CCW-M3 					# Es el sentido de giro que toma el tornillo para que la cama se hacerque al hotend (Sentido de giro horario/Manecillas de reloj CW; Anti-horario CCW). Y El Tipo de rosca del tornillo de nivelación en milimetros, Métrica 3 = M3. // CCW-M3 // CW-M4

########################################################################################
# DATOS PARA MALLA DE LA CAMA
########################################################################################

[bed_mesh]
speed: 25							# Velocidad de desplazamiento entre puntos de sondeo. // 50
horizontal_move_z: 15				# La coordenada Z a la que se eleva la sonda antes de desplazarse entre puntos. // 20

# Geometría DELTA
mesh_min: -70, -70
mesh_max: 70, 70
probe_count: 5, 5
#mesh_radius: 95						# Importante para Deltas (radio de la cama)
#mesh_origin: 0, 0                   # Centro de la cama para Deltas
#round_probe_count: 5				# Este valor entero define el número máximo de puntos sondeados a lo largo de los ejes X e Y. Este valor debe ser impar, ej: 5, 7 o 9); ya que se requiere sondear el centro de la malla. // 5

# Interpolación
mesh_pps: 3, 3						# Esta mesh_ppsopción es una abreviatura de "Puntos de malla por segmento". Esta opción especifica cuántos puntos se interpolarán para cada segmento a lo largo de los ejes X e Y.
algorithm: bicubic					# La interpolación bicúbica requiere un mínimo de 4 puntos de sondeo a lo largo de cada eje.
bicubic_tension: 0.2
move_check_distance: 5				# La distancia mínima para comprobar el cambio deseado en Z antes de realizar una división..
split_delta_z: 0.025				# Es la desviación mínima necesaria para activar una división de movimiento (Depende dela anterior funcion).

# KAMP / Adaptive
adaptive_margin: 5

# Fade
fade_start: 1						# La altura Z a partir de la cual se iniciará el ajuste de atenuación gradual. Es recomendable aplicar algunas capas antes de iniciar el proceso de atenuación.
fade_end: 10						# La altura Z a la que debe completarse el desvanecimiento. Si este valor es inferior a , fade_startel desvanecimiento se desactiva. 
fade_target: 0						# puede considerar como un desplazamiento Z adicional aplicado a toda la cama después de que se completa el desvanecimiento.

zero_reference_position: 0, 0	    # Debe ser la ubicación en la cama donde se realiza la prueba de papel

######################################################################
# CONFIGURACION DE DRIVERS
######################################################################

# X Driver ===> DRV8825, a 1/16 de paso; configurados asi: (M0>Low, M1>Low, M2>High).
# Y Driver ===> DRV8825, a 1/16 de paso; configurados asi: (M0>Low, M1>Low, M2>High).
# Z Driver ===> DRV8825, a 1/16 de paso; configurados asi: (M0>Low, M1>Low, M2>High).
# E Driver ===> DRV8825, a 1/16 de paso; configurados asi: (M0>Low, M1>Low, M2>High).

######################################################################
# CARGADO AUTOMATICO DE HOME-AUTOMATICO Y MALLA
######################################################################

[delayed_gcode start]
initial_duration: 1
gcode:
#  BED_MESH_PROFILE load=default
  G28
  G1 Z340.00 F620
  BORRAR_PAUSA
  M300 P500 S1500        # Tono de 500ms a 1500Hz para indicar finalización
  M117 Delta 3D Lista...

######################################################################
# CONFIGURACION MCU INPUT-SHAPER (ACELEROMETRO-ADXL345)
######################################################################

[mcu rpi]
serial: /tmp/klipper_host_mcu

[adxl345]
cs_pin: rpi:None       # Deja que spidev gestione el CS.
                       # Dependiendo de la orientación en tu efector, podrías necesitar:
                       # axes_map: x, y, z
# spi_bus: spidev0.0   # Fuerza el uso del bus de hardware 0.0

[resonance_tester]
accel_chip: adxl345
probe_points:
    0, 0, 20           # En cinematica Delta, el centro (0,0) a una altura segura (20mm)

[input_shaper]
shaper_freq_x: 47.8      # // 52.6 // 47.6 // 47.00 // 36.36 // 43.63 // 45.6 // 47.8
shaper_type_x: ei        # // mzv // zv // mzv // mzv // ei // ei // ei
shaper_freq_y: 48.4      # // 41.0 // 52.0 // 44.20 // 42.10 // 53.33 // 53.0 // 48.4
shaper_type_y: ei        # // mzv // zv // mzv // mzv // ei // mzv // ei

######################################################################
# CONFIGURACION BOARD
######################################################################

# Arduino aliases for atmega2560/1280 (Arduino mega) boards
[board_pins arduino-mega]
aliases:
    ar0=PE0, ar1=PE1, ar2=PE4, ar3=PE5, ar4=PG5,
    ar5=PE3, ar6=PH3, ar7=PH4, ar8=PH5, ar9=PH6,
    ar10=PB4, ar11=PB5, ar12=PB6, ar13=PB7, ar14=PJ1,
    ar15=PJ0, ar16=PH1, ar17=PH0, ar18=PD3, ar19=PD2,
    ar20=PD1, ar21=PD0, ar22=PA0, ar23=PA1, ar24=PA2,
    ar25=PA3, ar26=PA4, ar27=PA5, ar28=PA6, ar29=PA7,
    ar30=PC7, ar31=PC6, ar32=PC5, ar33=PC4, ar34=PC3,
    ar35=PC2, ar36=PC1, ar37=PC0, ar38=PD7, ar39=PG2,
    ar40=PG1, ar41=PG0, ar42=PL7, ar43=PL6, ar44=PL5,
    ar45=PL4, ar46=PL3, ar47=PL2, ar48=PL1, ar49=PL0,
    ar50=PB3, ar51=PB2, ar52=PB1, ar53=PB0, ar54=PF0,
    ar55=PF1, ar56=PF2, ar57=PF3, ar58=PF4, ar59=PF5,
    ar60=PF6, ar61=PF7, ar62=PK0, ar63=PK1, ar64=PK2,
    ar65=PK3, ar66=PK4, ar67=PK5, ar68=PK6, ar69=PK7,
    analog0=PF0, analog1=PF1, analog2=PF2, analog3=PF3, analog4=PF4,
    analog5=PF5, analog6=PF6, analog7=PF7, analog8=PK0, analog9=PK1,
    analog10=PK2, analog11=PK3, analog12=PK4, analog13=PK5, analog14=PK6,
    analog15=PK7,
    # Marlin adds these additional aliases
    ml70=PG4, ml71=PG3, ml72=PJ2, ml73=PJ3, ml74=PJ7,
    ml75=PJ4, ml76=PJ5, ml77=PJ6, ml78=PE2, ml79=PE6,
    ml80=PE7, ml81=PD4, ml82=PD5, ml83=PD6, ml84=PH2,
    ml85=PH7
    
######################################################################
# CONFIGURACIONES DE DISPLAY (LCD)
######################################################################

# Common EXP1 / EXP2 (display) pins
[board_pins]
aliases:
    # Common EXP1 header found on many "all-in-one" ramps clones
    EXP1_1=PC0, EXP1_3=PH0, EXP1_5=PA1, EXP1_7=PA5, EXP1_9=<GND>,
    EXP1_2=PC2, EXP1_4=PH1, EXP1_6=PA3, EXP1_8=PA7, EXP1_10=<5V>,
    # EXP2 header
    EXP2_1=PB3, EXP2_3=PC6, EXP2_5=PC4, EXP2_7=PL0, EXP2_9=<GND>,
    EXP2_2=PB1, EXP2_4=PB0, EXP2_6=PB2, EXP2_8=PG0, EXP2_10=<RST>
    # Pins EXP2_1, EXP2_6, EXP2_2 are also MISO, MOSI, SCK of bus "spi"
    # Note, some boards wire: EXP2_8=<RST>, EXP2_10=PG0

# See the sample-lcd.cfg file for definitions of common LCD displays.

# This file provides example configuration for common "RepRap" style
# LCD displays that use EXP1/EXP2 plugs.

# To configure a display from this file, make sure the main
# printer.cfg file has a [board_pins] config section defining pin
# aliases for the EXP1/EXP2 plugs, find the appropriate LCD type in
# this file, and then copy-and-paste that section into printer.cfg.

# See docs/Config_Reference.md for a description of parameters.

######################################################################
# "RepRapDiscount 128x64 Full Graphic Smart Controller" type displays
######################################################################

[display]
lcd_type: st7920
cs_pin: EXP1_4
sclk_pin: EXP1_5
sid_pin: EXP1_3
encoder_pins: ^EXP2_3, ^EXP2_5
click_pin: ^!EXP1_2
#kill_pin: ^!EXP2_8

[output_pin beeper]
pin: PC0           # Corresponde a EXP1_1 en la mayoría de las RAMPS
pwm: True
value: 0
shutdown_value: 0
cycle_time: 0.001

######################################################################
# Plug pin locations
######################################################################

# Some micro-controller boards and displays use inconsistent labeling
# for the EXP1 and EXP2 headers. The following diagram shows the
# correct location of pin 1 along with ground and power pins on the
# EXP1 and EXP2 plugs:
#
#          EXP1:                        EXP2:
#   +-----------------+          +-----------------+
#   |  o  o  o  o  5V |          |  o  o  o  o  o  |
#   |  1  o  o  o GND |          |  1  o  o  o GND |
#   +------     ------+          +------     ------+
#
# Some boards may have the cutout in the wrong location. If so, it may
# be possible to carefully pry the plastic header off of the pins with
# a small screwdriver, then correct the orientation and reapply the
# plastic header.

######################################################################
# CONFIGURACIONES AUTOMATICAS DE KLIPPER_WEB
######################################################################

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe]
#*# z_offset = -0.650
#*#
#*# [printer]
#*# delta_radius = 158.462003
#*#
#*# [stepper_a]
#*# angle = 211.951198
#*# arm_length = 292.000000
#*# position_endstop = 385.851285
#*#
#*# [stepper_b]
#*# angle = 331.282834
#*# arm_length = 292.000000
#*# position_endstop = 381.948929
#*#
#*# [stepper_c]
#*# angle = 90.000000
#*# arm_length = 292.000000
#*# position_endstop = 367.015525
#*#
#*# [delta_calibrate]
#*# height0 = -0.65
#*# height0_pos = 146948.800,147501.800,147437.600
#*# height1 = -0.65
#*# height1_pos = 166462.800,166462.800,131728.800
#*# height2 = -0.65
#*# height2_pos = 142606.200,180284.200,142592.000
#*# height3 = -0.65
#*# height3_pos = 133211.400,164568.400,164693.400
#*# height4 = -0.65
#*# height4_pos = 142305.200,143260.200,171222.200
#*# height5 = -0.65
#*# height5_pos = 160368.400,134636.400,161830.600
#*# height6 = -0.65
#*# height6_pos = 174010.400,142423.400,142485.400
